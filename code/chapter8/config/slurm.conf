# Slurm configuration for single-node setup with 2 H200 GPUs (GPU6 and GPU7)
ClusterName=distributed-ai
SlurmctldHost=moirai-h200

# Authentication
AuthType=auth/munge
CryptoType=crypto/munge

# Paths and files - using %n for per-node substitution
SlurmctldPidFile=/home/fuhwu/slurm/var/state/slurmctld.pid
SlurmctldPort=6817
SlurmdPidFile=/home/fuhwu/slurm/var/spool/%n/slurmd.pid
SlurmdPort=6818
SlurmdSpoolDir=/home/fuhwu/slurm/var/spool/%n
StateSaveLocation=/home/fuhwu/slurm/var/state

# Logging
SlurmctldDebug=info
SlurmctldLogFile=/home/fuhwu/slurm/var/log/slurmctld.log
SlurmdDebug=info
SlurmdLogFile=/home/fuhwu/slurm/var/log/slurmd.%n.log

# Process tracking and task binding
# Using proctrack/pgid for virtual nodes (doesn't require matching hardware topology)
# proctrack/linux requires exact hardware match, which fails with virtual nodes
ProctrackType=proctrack/pgid
TaskPlugin=task/affinity

# Scheduling
SchedulerType=sched/backfill
SelectType=select/cons_tres
SelectTypeParameters=CR_Core_Memory

# Resource limits
DefMemPerCPU=4000
MaxMemPerCPU=0

# Timeouts
SlurmctldTimeout=120
SlurmdTimeout=300
InactiveLimit=0
MinJobAge=300
KillWait=30
Waittime=0

# User
SlurmUser=fuhwu
SlurmdUser=fuhwu

# MPI support for distributed training
# Using pmi2 - PMIx plugin requires Slurm recompile with --with-pmix
# To use PMIx: recompile Slurm with: ./configure ... --with-pmix
MpiDefault=pmi2

# GRES
GresTypes=gpu

# 2 virtual nodes for GPU6 and GPU7
# Each node uses different port for multiple slurmd support
# Hardware: 2 sockets, 56 cores/socket, 2 threads/core = 224 CPUs total
# For virtual nodes, let Slurm auto-detect hardware topology
# Each virtual node will share the same physical hardware
NodeName=node6 NodeHostname=moirai-h200 Port=17016 \
    CPUs=112 RealMemory=240000 Gres=gpu:1 State=UNKNOWN

NodeName=node7 NodeHostname=moirai-h200 Port=17017 \
    CPUs=112 RealMemory=240000 Gres=gpu:1 State=UNKNOWN

# GPU partition with 2 nodes
PartitionName=gpu Nodes=node6,node7 Default=YES MaxTime=INFINITE State=UP OverSubscribe=NO
